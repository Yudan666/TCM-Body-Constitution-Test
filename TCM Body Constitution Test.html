<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸­åŒ»ä½“è´¨è¾¨è¯†è‡ªæµ‹</title>
    <style>
        /* --- Coffee / Aura Style Theme --- */
        :root {
            --bg-body: #F9F7F2; /* æš–ç±³è‰²èƒŒæ™¯ */
            --bg-card: #FFFFFF;
            --primary: #BC8F58; /* æ‹¿é“é‡‘/å’–å•¡è‰² */
            --primary-dark: #8C6A40;
            --text-main: #2C2622; /* æ·±è¤/é»‘è‰² */
            --text-secondary: #7A726A;
            --accent-green: #6B8E23; /* æŠ¹èŒ¶ç»¿ (ç”¨äºå¹³å’Œ/å¥åº·) */
            --accent-red: #D9534F; /* è­¦ç¤ºçº¢ */
            
            --font-serif: "Palatino Linotype", "Book Antiqua", Palatino, serif; /* è¡¬çº¿ä½“ */
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            --radius-card: 24px;
            --radius-btn: 12px;
            --shadow-soft: 0 10px 40px rgba(188, 143, 88, 0.1);
            --shadow-hover: 0 15px 50px rgba(188, 143, 88, 0.2);
            
            --transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none; /* å»é™¤é»˜è®¤é»‘æ¡† */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        button:focus {
            outline: none; /* å†æ¬¡ç¡®ä¿å»é™¤é»‘æ¡† */
        }

        /* Container */
        .app-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Typography & Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .brand {
            font-family: var(--font-serif);
            font-weight: 700;
            font-size: 24px;
            color: var(--text-main);
            letter-spacing: 0.5px;
        }

        .link-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .link-btn:hover { background: rgba(188, 143, 88, 0.1); }

        h1.hero-title {
            font-family: var(--font-serif);
            font-size: 42px;
            line-height: 1.2;
            margin-bottom: 16px;
            color: var(--text-main);
        }

        p.hero-desc {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 40px;
            max-width: 500px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-card);
            padding: 32px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.3s ease;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: var(--radius-btn);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(188, 143, 88, 0.3);
            width: 100%;
            max-width: 300px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn:active { transform: scale(0.98); }

        .btn-outline {
            background: transparent;
            border: 2px solid #E0E0E0;
            color: var(--text-secondary);
            box-shadow: none;
        }
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: transparent;
        }

        .btn-text-back {
            background: transparent;
            color: var(--text-secondary);
            box-shadow: none;
            padding: 0;
            width: auto;
            justify-content: flex-start;
        }
        .btn-text-back:hover { background: transparent; color: var(--text-main); box-shadow: none; transform: none; }

        /* Gender Selection */
        .gender-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 24px 0;
        }

        .gender-option {
            padding: 16px 10px;
            border-radius: 16px;
            background: #F5F5F5;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .gender-option.selected {
            background: #FFFBF5;
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(188, 143, 88, 0.15);
        }

        /* Custom Slider (Smooth & Animated) */
        .slider-wrapper {
            padding: 20px 0 10px;
            position: relative;
            user-select: none;
        }

        .slider-track-bg {
            height: 6px;
            background: #EAEAEA;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
        }

        /* The thumb */
        .slider-thumb {
            width: 28px;
            height: 28px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: grab;
            transition: left 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.2s;
            z-index: 2;
        }
        .slider-thumb.dragging { transition: none; cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); }
        .slider-thumb.active { background: var(--primary); }

        /* Ticks */
        .slider-ticks {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 100%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .tick {
            width: 6px;
            height: 6px;
            background: #D1D1D1;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        .slider-labels-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .slider-labels-top span:first-child { color: var(--accent-red); } /* æ€»æ˜¯ */
        .slider-labels-top span:last-child { color: var(--accent-green); } /* æ²¡æœ‰ */

        .current-val-display {
            text-align: center;
            height: 24px;
            margin-top: 10px;
            font-size: 15px;
            font-weight: 600;
            color: var(--primary);
            opacity: 0;
            transform: translateY(5px);
            transition: all 0.3s;
        }
        .current-val-display.show { opacity: 1; transform: translateY(0); }

        /* Quiz Layout */
        .question-card {
            border-left: 4px solid transparent;
            animation: slideUp 0.4s ease-out backwards;
        }
        .question-card.active-card {
            border-left-color: var(--primary);
        }
        .question-card.error {
            border-color: var(--accent-red);
            animation: shake 0.4s;
        }

        .q-number {
            font-family: var(--font-serif);
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .q-text {
            font-size: 19px;
            font-weight: 600;
            margin-bottom: 24px;
            line-height: 1.5;
            color: var(--text-main);
        }

        /* Results */
        .result-hero {
            text-align: center;
            padding: 40px 20px;
        }
        
        .result-badge {
            display: inline-block;
            background: #FFF8E1;
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 16px;
            letter-spacing: 1px;
        }

        .main-type {
            font-family: var(--font-serif);
            font-size: 48px;
            font-weight: 700;
            color: var(--text-main);
            margin: 0 0 10px 0;
        }

        .sub-type {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* Chart */
        .bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        .bar-label { width: 70px; font-size: 14px; font-weight: 600; color: var(--text-secondary); }
        .bar-track { flex: 1; height: 10px; background: #F0F0F0; border-radius: 5px; overflow: hidden; margin: 0 12px; }
        .bar-fill { height: 100%; background: #DDD; border-radius: 5px; width: 0; transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .bar-val { width: 35px; text-align: right; font-size: 13px; color: #999; }

        .bar-fill.high { background: var(--accent-red); } /* â‰¥40 */
        .bar-fill.mid { background: var(--primary); } /* 30-39 */
        .bar-fill.health { background: var(--accent-green); } /* å¹³å’Œ */

        /* Advice Section */
        .advice-section {
            background: #FAF9F6;
            border-radius: 16px;
            padding: 24px;
            margin-top: 20px;
        }
        .advice-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .advice-item:last-child { border: none; margin: 0; padding: 0; }
        .advice-title { font-weight: 700; color: var(--text-main); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;}

        /* Modals */
        .modal-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 38, 34, 0.4);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-wrap.active { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: white;
            width: 90%; max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 24px;
            padding: 32px;
            transform: translateY(20px);
            transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .modal-wrap.active .modal-box { transform: translateY(0); }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .hidden { display: none !important; }

        @media (max-width: 600px) {
            h1.hero-title { font-size: 32px; }
            .card { padding: 24px 20px; }
            .gender-options { gap: 8px; }
            .gender-option { font-size: 13px; padding: 12px 4px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- Top Nav -->
    <header>
        <div class="brand">TCM Body Check</div>
        <button class="link-btn" onclick="showInfoModal()">ä»€ä¹ˆæ˜¯ä½“è´¨?</button>
    </header>

    <!-- 1. Landing View -->
    <div id="view-landing">
        <div style="padding: 20px 0;">
            <p style="color: var(--primary); font-weight: 700; letter-spacing: 1px; font-size: 14px; text-transform: uppercase;">Ancient Wisdom Â· Modern Insight</p>
            <h1 class="hero-title">æ¢ç´¢ä½ çš„èº«ä½“<br>å±äºå“ªç§è‡ªç„¶å±æ€§</h1>
            <p class="hero-desc">æºè‡ªä¸­åä¸­åŒ»è¯å­¦ä¼šæ ‡å‡†ï¼Œ60é“ä¸“ä¸šè‡ªæµ‹é¢˜ï¼Œä¸ºæ‚¨è§£ç èº«ä½“çš„å¯’çƒ­è™šå®ï¼Œæä¾›ä¸ªæ€§åŒ–å…»ç”Ÿå»ºè®®ã€‚</p>
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-family: var(--font-serif);">å¼€å§‹å‰çš„å‡†å¤‡</h3>
            <p style="font-size:14px; color:#666;">ä¸ºäº†æä¾›æ›´ç²¾å‡†çš„é¢˜ç›®ï¼Œè¯·é€‰æ‹©æ‚¨çš„æ€§åˆ«ï¼ˆéƒ¨åˆ†é¢˜ç›®å­˜åœ¨ç”Ÿç†å·®å¼‚ï¼‰ï¼š</p>
            
            <div class="gender-options">
                <div class="gender-option" onclick="setGender('male', this)">ç”·æ€§ ğŸ™‹â€â™‚ï¸</div>
                <div class="gender-option" onclick="setGender('female', this)">å¥³æ€§ ğŸ™‹â€â™€ï¸</div>
                <div class="gender-option selected" onclick="setGender('undisclosed', this)">ä¸ä¾¿é€éœ² ğŸ¤</div>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn" onclick="startQuiz()">å¼€å§‹æµ‹è¯•</button>
            </div>
            <p style="font-size:12px; color:#aaa; margin-top:16px; text-align:center;">ç¦»çº¿è¿è¡Œ â€¢ éšç§å®‰å…¨ â€¢ ä¸ä¸Šä¼ ä»»ä½•æ•°æ®</p>
        </div>
    </div>

    <!-- 2. Quiz View -->
    <div id="view-quiz" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <button class="btn-text-back" onclick="confirmExit()">â† é€€å‡º</button>
            <div style="font-size: 14px; color: var(--text-secondary); font-weight: 600;">è¿›åº¦ <span id="progress-text">1/7</span></div>
        </div>
        
        <!-- Progress Bar Line -->
        <div style="height: 4px; background: #E0E0E0; border-radius: 2px; margin-bottom: 30px; overflow: hidden;">
            <div id="progress-fill" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.4s;"></div>
        </div>

        <div id="question-list">
            <!-- Questions Injected Here -->
        </div>

        <div style="display: flex; gap: 16px; margin-top: 40px; padding-bottom: 40px;">
            <button id="btn-prev" class="btn btn-outline" style="flex:1" onclick="navPage(-1)">ä¸Šä¸€é¡µ</button>
            <button id="btn-next" class="btn" style="flex:2" onclick="navPage(1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- 3. Result View -->
    <div id="view-result" class="hidden">
        <div class="card result-hero">
            <div class="result-badge">âœ¨ æµ‹è¯„æŠ¥å‘Šå·²ç”Ÿæˆ</div>
            <h1 class="main-type" id="res-main-title">å¹³å’Œè´¨</h1>
            <p class="sub-type" id="res-sub-desc">é˜´é˜³å¹³è¡¡ï¼Œè„è…‘åè°ƒï¼Œæ°”è¡€å……è¶³ã€‚</p>
            
            <div id="res-tags" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px;">
                <!-- Tags like "å…¼æœ‰æ¹¿çƒ­", "å€¾å‘æ°”è™š" -->
            </div>
        </div>

        <div class="card">
            <h3 style="font-family: var(--font-serif); border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 20px;">ä½“è´¨é›·è¾¾å›¾</h3>
            <div id="chart-container">
                <!-- Bars -->
            </div>
        </div>

        <div class="card">
            <h3 style="font-family: var(--font-serif);">è°ƒç†å»ºè®® & ç”Ÿæ´»æŒ‡å— ğŸµ</h3>
            <div id="advice-list" class="advice-section">
                <!-- Advice Content -->
            </div>
            <div style="font-size:12px; color:#999; margin-top:20px; line-height:1.5;">
                å…è´£å£°æ˜ï¼šæœ¬æµ‹è¯•ç»“æœä»…ä¾›å¥åº·ç®¡ç†å‚è€ƒï¼Œä¸ä½œä¸ºåŒ»ç–—è¯Šæ–­ä¾æ®ã€‚å¦‚æœ‰æ˜æ˜¾ä¸é€‚ï¼Œè¯·å‰å¾€æ­£è§„åŒ»é™¢å°±è¯Šã€‚
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 16px; padding-bottom: 40px; align-items: center;">
            <button class="btn" onclick="reviewAnswers()">âœï¸ è¿”å›ä¿®æ”¹ / æŸ¥çœ‹é¢˜ç›®</button>
            <button class="btn btn-outline" onclick="resetApp()">ğŸ”„ é‡æ–°æµ‹è¯• (æ¸…ç©º)</button>
        </div>
    </div>

</div>

<!-- Info Modal -->
<div id="modal-info" class="modal-wrap">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; font-family:var(--font-serif);">å…³äºä¸­åŒ»ä¹ç§ä½“è´¨</h2>
            <button onclick="closeModal('modal-info')" style="background:none; border:none; font-size:24px; color:#999; cursor:pointer;">&times;</button>
        </div>
        <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.7;">
            <p><strong>ğŸƒ å¹³å’Œè´¨ (Type A)</strong><br>æœ€ç†æƒ³çš„ä½“è´¨ã€‚ä½“å½¢åŒ€ç§°ï¼Œå¥å£®ï¼Œé¢è‰²çº¢æ¶¦ï¼Œç²¾åŠ›å……æ²›ã€‚å¯¹å¤–ç•Œç¯å¢ƒé€‚åº”èƒ½åŠ›å¼ºã€‚</p>
            <p><strong>â„ï¸ é˜³è™šè´¨ (Type B)</strong><br>æ€•å†·æ´¾ã€‚æ‰‹è„šå‘å‡‰ï¼Œèƒƒè„˜éƒ¨ã€èƒŒéƒ¨æˆ–è…°è†éƒ¨æ€•å†·ï¼Œè¡£æœæ¯”åˆ«äººç©¿å¾—å¤šã€‚æ€§æ ¼å¤šæ²‰é™ã€å†…å‘ã€‚</p>
            <p><strong>ğŸ”¥ é˜´è™šè´¨ (Type C)</strong><br>ç¼ºæ°´æ´¾ã€‚æ‰‹å¿ƒè„šå¿ƒå‘çƒ­ï¼Œå£å¹²å’½ç‡¥ï¼Œé¢éƒ¨æ½®çº¢ï¼Œå®¹æ˜“ä¾¿ç§˜ã€‚æ€§æ ¼å¤šæ€¥èºã€å¤–å‘ã€‚</p>
            <p><strong>â˜ï¸ æ°”è™šè´¨ (Type D)</strong><br>æ°”çŸ­æ´¾ã€‚è¯´è¯å£°éŸ³ä½å¼±ï¼Œå®¹æ˜“ç–²ä¹ï¼Œæ°”çŸ­ï¼Œæ˜“å‡ºæ±—ã€‚æ€§æ ¼å†…å‘ï¼Œæƒ…ç»ªä¸ç¨³å®šã€‚</p>
            <p><strong>ğŸ’§ ç—°æ¹¿è´¨ (Type E)</strong><br>ä½“èƒ–æ´¾ã€‚è…¹éƒ¨è‚¥æ»¡ï¼Œæ¾è½¯ï¼Œé¢éƒ¨çš®è‚¤æ²¹è„‚è¾ƒå¤šã€‚æ€§æ ¼åæ¸©å’Œã€ç¨³é‡ã€‚</p>
            <p><strong>ğŸŒ‹ æ¹¿çƒ­è´¨ (Type F)</strong><br>é•¿ç—˜æ´¾ã€‚é¢å¢æ²¹å…‰ï¼Œæ˜“ç”Ÿç—¤ç–®ï¼Œå£è‹¦å£å¹²ï¼Œèº«é‡å›°å€¦ã€‚æ€§æ ¼å¤šæ€¥èºæ˜“æ€’ã€‚</p>
            <p><strong>ğŸŒ‘ è¡€ç˜€è´¨ (Type G)</strong><br>é•¿æ–‘æ´¾ã€‚é¢è‰²æ™¦æš—ï¼Œè‰²ç´ æ²‰ç€ï¼Œå®¹æ˜“å‡ºç°ç˜€æ–‘ï¼Œå£å”‡é»¯æ·¡ã€‚æ€§æ ¼æ˜“çƒ¦ï¼Œå¥å¿˜ã€‚</p>
            <p><strong>ğŸŒ€ æ°”éƒè´¨ (Type H)</strong><br>éƒé—·æ´¾ã€‚ç¥æƒ…æŠ‘éƒï¼Œæƒ…æ„Ÿè„†å¼±ï¼Œçƒ¦é—·ä¸ä¹ã€‚å¤šæ„å–„æ„Ÿï¼Œå®¹æ˜“å¤±çœ ã€‚</p>
            <p><strong>ğŸ¤§ ç‰¹ç¦€è´¨ (Type I)</strong><br>è¿‡æ•æ´¾ã€‚å®¹æ˜“è¿‡æ•ï¼ˆè¯ç‰©ã€é£Ÿç‰©ã€èŠ±ç²‰ï¼‰ï¼Œæ‰“å–·åšï¼Œæµé¼»æ¶•ã€‚é€‚åº”èƒ½åŠ›å·®ã€‚</p>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div id="modal-alert" class="modal-wrap">
    <div class="modal-box" style="text-align:center; max-width:320px;">
        <h3 id="alert-title" style="margin-top:0">æç¤º</h3>
        <p id="alert-msg" style="color:#666; margin-bottom:24px;">å†…å®¹</p>
        <button class="btn" onclick="closeModal('modal-alert')">çŸ¥é“äº†</button>
    </div>
</div>

<script>
/**
 * ------------------------------------------------------------------
 * Data Layer (Standard TCM Questions)
 * ------------------------------------------------------------------
 */
const TYPES = {
    A: { name: 'é˜³è™šè´¨', desc: 'é˜³æ°”ä¸è¶³ï¼Œä»¥ç•å¯’æ€•å†·ã€æ‰‹è¶³ä¸æ¸©ç­‰è™šå¯’è¡¨ç°ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'â„ï¸' },
    B: { name: 'é˜´è™šè´¨', desc: 'é˜´æ¶²äºå°‘ï¼Œä»¥å£ç‡¥å’½å¹²ã€æ‰‹è¶³å¿ƒçƒ­ç­‰è™šçƒ­è¡¨ç°ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'ğŸ”¥' },
    C: { name: 'æ°”è™šè´¨', desc: 'å…ƒæ°”ä¸è¶³ï¼Œä»¥ç–²ä¹ã€æ°”çŸ­ã€è‡ªæ±—ç­‰æ°”è™šè¡¨ç°ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'â˜ï¸' },
    D: { name: 'ç—°æ¹¿è´¨', desc: 'ç—°æ¹¿å‡èšï¼Œä»¥å½¢ä½“è‚¥èƒ–ã€è…¹éƒ¨è‚¥æ»¡ã€å£é»è‹”è…»ç­‰ç—°æ¹¿è¡¨ç°ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'ğŸ’§' },
    E: { name: 'æ¹¿çƒ­è´¨', desc: 'æ¹¿çƒ­å†…è•´ï¼Œä»¥é¢å¢æ²¹å…‰ã€å£è‹¦ã€è‹”é»„è…»ç­‰æ¹¿çƒ­è¡¨ç°ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'ğŸŒ‹' },
    F: { name: 'è¡€ç˜€è´¨', desc: 'è¡€è¡Œä¸ç•…ï¼Œä»¥è‚¤è‰²æ™¦é»¯ã€èˆŒè´¨ç´«é»¯ç­‰è¡€ç˜€è¡¨ç°ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'ğŸŒ‘' },
    G: { name: 'æ°”éƒè´¨', desc: 'æ°”æœºéƒæ»ï¼Œä»¥ç¥æƒ…æŠ‘éƒã€å¿§è™‘è„†å¼±ç­‰æ°”éƒè¡¨ç°ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'ğŸŒ€' },
    H: { name: 'ç‰¹ç¦€è´¨', desc: 'å…ˆå¤©å¤±å¸¸ï¼Œä»¥ç”Ÿç†ç¼ºé™·ã€è¿‡æ•ååº”ç­‰ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'ğŸ¤§' },
    I: { name: 'å¹³å’Œè´¨', desc: 'é˜´é˜³æ°”è¡€è°ƒå’Œï¼Œä»¥ä½“æ€é€‚ä¸­ã€é¢è‰²çº¢æ¶¦ã€ç²¾åŠ›å……æ²›ç­‰ä¸ºä¸»è¦ç‰¹å¾ã€‚', emoji: 'ğŸƒ' }
};

// Complete 60+ Question Bank
// reverse: true means answer 1=1pt, 5=5pt. Default is 1=5pt, 5=1pt (since 1 is "Always" which is bad for health usually)
const QUESTIONS = [
    // é˜³è™š (A)
    { id: 1, text: "æ‚¨æ‰‹è„šå‘å‡‰å—ï¼Ÿ", type: 'A' },
    { id: 2, text: "æ‚¨èƒƒè„˜éƒ¨ã€èƒŒéƒ¨æˆ–è…°è†éƒ¨æ€•å†·å—ï¼Ÿ", type: 'A' },
    { id: 3, text: "æ‚¨æ„Ÿåˆ°æ€•å†·ã€è¡£æœæ¯”åˆ«äººç©¿å¾—å¤šå—ï¼Ÿ", type: 'A' },
    { id: 4, text: "æ‚¨æ¯”ä¸€èˆ¬äººä¸äº†å¯’å†·ï¼ˆå†¬å¤©çš„å¯’å†·ï¼Œå¤å¤©çš„å†·ç©ºè°ƒã€ç”µæ‰‡ç­‰ï¼‰å—ï¼Ÿ", type: 'A' },
    { id: 5, text: "æ‚¨æ¯”åˆ«äººå®¹æ˜“æ‚£æ„Ÿå†’å—ï¼Ÿ", type: 'A' },
    { id: 6, text: "æ‚¨åƒ(å–)å‡‰çš„ä¸œè¥¿ä¼šæ„Ÿåˆ°ä¸èˆ’æœæˆ–è€…æ€•åƒ(å–)å‡‰çš„ä¸œè¥¿å—ï¼Ÿ", type: 'A' },
    { id: 7, text: "æ‚¨å—å‡‰æˆ–åƒ(å–)å‡‰çš„ä¸œè¥¿åï¼Œå®¹æ˜“è…¹æ³»(æ‹‰è‚šå­)å—ï¼Ÿ", type: 'A' },
    // é˜´è™š (B)
    { id: 8, text: "æ‚¨æ„Ÿåˆ°æ‰‹è„šå¿ƒå‘çƒ­å—ï¼Ÿ", type: 'B' },
    { id: 9, text: "æ‚¨æ„Ÿè§‰èº«ä½“ã€è„¸ä¸Šå‘çƒ­å—ï¼Ÿ", type: 'B' },
    { id: 10, text: "æ‚¨çš®è‚¤æˆ–å£å”‡å¹²å—ï¼Ÿ", type: 'B' },
    { id: 11, text: "æ‚¨å£å”‡çš„é¢œè‰²æ¯”ä¸€èˆ¬äººçº¢å—ï¼Ÿ", type: 'B' },
    { id: 12, text: "æ‚¨å®¹æ˜“ä¾¿ç§˜æˆ–å¤§ä¾¿å¹²ç‡¥å—ï¼Ÿ", type: 'B' },
    { id: 13, text: "æ‚¨é¢éƒ¨ä¸¤é¢§æ½®çº¢æˆ–åçº¢å—ï¼Ÿ", type: 'B' },
    { id: 14, text: "æ‚¨æ„Ÿåˆ°çœ¼ç›å¹²æ¶©å—ï¼Ÿ", type: 'B' },
    { id: 15, text: "æ‚¨æ„Ÿåˆ°å£å¹²å’½ç‡¥ã€æ€»æƒ³å–æ°´å—ï¼Ÿ", type: 'B' },
    // æ°”è™š (C)
    { id: 16, text: "æ‚¨å®¹æ˜“ç–²ä¹å—ï¼Ÿ", type: 'C' },
    { id: 17, text: "æ‚¨å®¹æ˜“æ°”çŸ­(å‘¼å¸çŸ­ä¿ƒï¼Œæ¥ä¸ä¸Šæ°”)å—ï¼Ÿ", type: 'C' },
    { id: 18, text: "æ‚¨å®¹æ˜“å¿ƒæ…Œå—ï¼Ÿ", type: 'C' },
    { id: 19, text: "æ‚¨å®¹æ˜“å¤´æ™•æˆ–ç«™èµ·æ—¶æ™•çœ©å—ï¼Ÿ", type: 'C' },
    { id: 20, text: "æ‚¨æ¯”åˆ«äººå®¹æ˜“æ‚£æ„Ÿå†’å—ï¼Ÿ", type: 'C' },
    { id: 21, text: "æ‚¨å–œæ¬¢å®‰é™ã€æ‡’å¾—è¯´è¯å—ï¼Ÿ", type: 'C' },
    { id: 22, text: "æ‚¨è¯´è¯å£°éŸ³ä½å¼±æ— åŠ›å—ï¼Ÿ", type: 'C' },
    { id: 23, text: "æ‚¨æ´»åŠ¨é‡ç¨å¤§å°±å®¹æ˜“å‡ºè™šæ±—å—ï¼Ÿ", type: 'C' },
    // ç—°æ¹¿ (D)
    { id: 24, text: "æ‚¨æ„Ÿåˆ°èƒ¸é—·æˆ–è…¹éƒ¨èƒ€æ»¡å—ï¼Ÿ", type: 'D' },
    { id: 25, text: "æ‚¨æ„Ÿåˆ°èº«ä½“æ²‰é‡ä¸è½»æ¾æˆ–ä¸çˆ½å¿«å—ï¼Ÿ", type: 'D' },
    { id: 26, text: "æ‚¨è…¹éƒ¨è‚¥æ»¡æ¾è½¯å—ï¼Ÿ", type: 'D' },
    { id: 27, text: "æ‚¨æœ‰é¢éƒ¨æ²¹è„‚åˆ†æ³Œå¤šçš„ç°è±¡å—ï¼Ÿ", type: 'D' },
    { id: 28, text: "æ‚¨ä¸Šçœ¼ç‘æ¯”åˆ«äººè‚¿(ä¸Šçœ¼ç‘æœ‰è½»å¾®éš†èµ·çš„ç°è±¡)å—ï¼Ÿ", type: 'D' },
    { id: 29, text: "æ‚¨å˜´é‡Œæœ‰é»é»çš„æ„Ÿè§‰å—ï¼Ÿ", type: 'D' },
    { id: 30, text: "æ‚¨å¹³æ—¶ç—°å¤šï¼Œç‰¹åˆ«æ˜¯å’½å–‰éƒ¨æ€»æ„Ÿåˆ°æœ‰ç—°å µç€å—ï¼Ÿ", type: 'D' },
    { id: 31, text: "æ‚¨èˆŒè‹”åšè…»æˆ–æœ‰èˆŒè‹”åšåšçš„æ„Ÿè§‰å—ï¼Ÿ", type: 'D' },
    // æ¹¿çƒ­ (E)
    { id: 32, text: "æ‚¨é¢éƒ¨æˆ–é¼»éƒ¨æœ‰æ²¹è…»æ„Ÿæˆ–è€…æ²¹äº®å‘å…‰å—ï¼Ÿ", type: 'E' },
    { id: 33, text: "æ‚¨å®¹æ˜“ç”Ÿç—¤ç–®æˆ–ç–®ç––å—ï¼Ÿ", type: 'E' },
    { id: 34, text: "æ‚¨æ„Ÿåˆ°å£è‹¦æˆ–å˜´é‡Œæœ‰å¼‚å‘³å—ï¼Ÿ", type: 'E' },
    { id: 35, text: "æ‚¨å¤§ä¾¿é»æ»ä¸çˆ½ã€æœ‰è§£ä¸å°½çš„æ„Ÿè§‰å—ï¼Ÿ", type: 'E' },
    { id: 36, text: "æ‚¨å°ä¾¿æ—¶å°¿é“æœ‰å‘çƒ­æ„Ÿã€å°¿è‰²æµ“(æ·±)å—ï¼Ÿ", type: 'E' },
    { id: 37, text: "æ‚¨å¸¦ä¸‹è‰²é»„(ç™½å¸¦é¢œè‰²å‘é»„)å—ï¼Ÿ(é™å¥³æ€§)", type: 'E', gender: 'female' },
    { id: 38, text: "æ‚¨çš„é˜´å›Šæ½®æ¹¿å—ï¼Ÿ(é™ç”·æ€§)", type: 'E', gender: 'male' },
    // è¡€ç˜€ (F)
    { id: 39, text: "æ‚¨çš„çš®è‚¤åœ¨ä¸çŸ¥ä¸è§‰ä¸­ä¼šå‡ºç°é’ç´«ç˜€æ–‘(çš®ä¸‹å‡ºè¡€)å—ï¼Ÿ", type: 'F' },
    { id: 40, text: "æ‚¨ä¸¤é¢§éƒ¨æœ‰ç»†å¾®çº¢ä¸å—ï¼Ÿ", type: 'F' },
    { id: 41, text: "æ‚¨èº«ä½“ä¸Šæœ‰å“ªé‡Œç–¼ç—›å—ï¼Ÿ", type: 'F' },
    { id: 42, text: "æ‚¨é¢è‰²æ™¦æš—æˆ–å®¹æ˜“å‡ºç°è¤æ–‘å—ï¼Ÿ", type: 'F' },
    { id: 43, text: "æ‚¨å®¹æ˜“æœ‰é»‘çœ¼åœˆå—ï¼Ÿ", type: 'F' },
    { id: 44, text: "æ‚¨å®¹æ˜“å¿˜äº‹(å¥å¿˜)å—ï¼Ÿ", type: 'F' },
    { id: 45, text: "æ‚¨å£å”‡é¢œè‰²åé»¯å—ï¼Ÿ", type: 'F' },
    // æ°”éƒ (G)
    { id: 46, text: "æ‚¨æ„Ÿåˆ°é—·é—·ä¸ä¹ã€æƒ…ç»ªä½æ²‰å—ï¼Ÿ", type: 'G' },
    { id: 47, text: "æ‚¨å®¹æ˜“ç²¾ç¥ç´§å¼ ã€ç„¦è™‘ä¸å®‰å—ï¼Ÿ", type: 'G' },
    { id: 48, text: "æ‚¨å¤šæ„å–„æ„Ÿã€æ„Ÿæƒ…è„†å¼±å—ï¼Ÿ", type: 'G' },
    { id: 49, text: "æ‚¨å®¹æ˜“æ„Ÿåˆ°å®³æ€•æˆ–å—åˆ°æƒŠå“å—ï¼Ÿ", type: 'G' },
    { id: 50, text: "æ‚¨èƒè‚‹éƒ¨æˆ–ä¹³æˆ¿èƒ€ç—›å—ï¼Ÿ", type: 'G' },
    { id: 51, text: "æ‚¨æ— ç¼˜æ— æ•…å¹æ°”å—ï¼Ÿ", type: 'G' },
    { id: 52, text: "æ‚¨å’½å–‰éƒ¨æœ‰å¼‚ç‰©æ„Ÿï¼Œä¸”åä¹‹ä¸å‡ºã€å’½ä¹‹ä¸ä¸‹å—ï¼Ÿ", type: 'G' },
    // ç‰¹ç¦€ (H)
    { id: 53, text: "æ‚¨æ²¡æœ‰æ„Ÿå†’æ—¶ä¹Ÿä¼šæ‰“å–·åšå—ï¼Ÿ", type: 'H' },
    { id: 54, text: "æ‚¨æ²¡æœ‰æ„Ÿå†’æ—¶ä¹Ÿä¼šæµé¼»æ¶•å—ï¼Ÿ", type: 'H' },
    { id: 55, text: "æ‚¨æœ‰å› å­£èŠ‚å˜åŒ–ã€æ¸©åº¦å˜åŒ–æˆ–å¼‚å‘³ç­‰åŸå› è€Œå’³å–˜çš„ç°è±¡å—ï¼Ÿ", type: 'H' },
    { id: 56, text: "æ‚¨å®¹æ˜“è¿‡æ•(å¯¹è¯ç‰©ã€é£Ÿç‰©ã€æ°”å‘³ã€èŠ±ç²‰æˆ–åœ¨å­£èŠ‚äº¤æ›¿ã€æ°”å€™å˜åŒ–æ—¶)å—ï¼Ÿ", type: 'H' },
    { id: 57, text: "æ‚¨çš„çš®è‚¤å®¹æ˜“èµ·è¨éº»ç–¹(é£å›¢ã€é£ç–¹å—ã€é£ç–™ç˜©)å—ï¼Ÿ", type: 'H' },
    { id: 58, text: "æ‚¨çš„çš®è‚¤å› è¿‡æ•å‡ºç°è¿‡ç´«ç™œ(ç´«çº¢è‰²å‡ºè¡€ç‚¹ã€ç˜€æ–‘)å—ï¼Ÿ", type: 'H' },
    { id: 59, text: "æ‚¨çš„çš®è‚¤ä¸€æŠ“å°±çº¢ï¼Œå¹¶å‡ºç°æŠ“ç—•å—ï¼Ÿ", type: 'H' },
    // å¹³å’Œ (I) - * æ³¨æ„ï¼šè¿™äº›æ˜¯åå‘é¢˜ï¼Œå³â€œå¥½â€çš„ç°è±¡
    // è§„åˆ™ï¼šå¹³å’Œè´¨é¢˜ç›®åŸå§‹åˆ†ä¸º1-5ã€‚è®¡ç®—è½¬åŒ–åˆ†æ—¶ï¼Œéœ€è¦æ ¹æ®å®é™…å«ä¹‰åè½¬ã€‚
    // è¿™é‡Œæˆ‘ä»¬æ ‡è®° reverse:true è¡¨ç¤ºâ€œå¾—åˆ†ç›´æ¥ç”¨åŸå§‹åˆ†â€ï¼ˆå¦‚æœ1=æ€»æ˜¯ï¼Œé‚£ä¹ˆæ€»æ˜¯ç²¾åŠ›å……æ²›=1åˆ†ï¼Ÿä¸å¯¹ï¼‰
    // è®©æˆ‘ä»¬ç†æ¸…ï¼šå¹³å’Œè´¨é¢˜ç›®æ˜¯â€œç²¾åŠ›å……æ²›â€ã€â€œé€‚åº”èƒ½åŠ›å¼ºâ€ã€‚
    // æ»‘å—ï¼šå·¦(1)=æ€»æ˜¯ï¼Œå³(5)=æ²¡æœ‰ã€‚
    // é—®å·åŸæ„ï¼š1=æ²¡æœ‰ï¼Œ5=æ€»æ˜¯ã€‚
    // å¯¹äºâ€œç²¾åŠ›å……æ²›â€ï¼šé€‰â€œæ€»æ˜¯â€åº”è¯¥æ˜¯å¥½çš„ã€‚
    // å¹³å’Œè´¨è®¡ç®—å…¬å¼ï¼šï¼ˆåŸå§‹åˆ†-æ¡ç›®æ•°ï¼‰/...
    // å¹³å’Œè´¨çš„æ ‡å‡†æ˜¯å¾—åˆ†è¶Šé«˜è¶Šå¹³å’Œã€‚æ‰€ä»¥â€œæ€»æ˜¯ç²¾åŠ›å……æ²›â€åº”è¯¥å¾—5åˆ†ã€‚
    // æˆ‘ä»¬çš„æ»‘å— Left=1(æ€»æ˜¯)ã€‚æ‰€ä»¥å¯¹å¹³å’Œè´¨æ­£å‘é¢˜ï¼ŒScore = 6 - Val (Left 1 -> Score 5).
    // ä½†æ˜¯ï¼å›¾ç‰‡é‡Œæœ‰5ä¸ªå¸¦*çš„é¢˜ï¼šç–²ä¹ã€å£°éŸ³ä½å¼±ã€æƒ…ç»ªä½æ²‰ã€æ€•å†·ã€‚è¿™äº›æ˜¯è´Ÿå‘é¢˜ã€‚
    // è´Ÿå‘é¢˜ï¼šé€‰â€œæ€»æ˜¯â€ï¼ˆ1ï¼‰è¯´æ˜ä¸å¹³å’Œï¼Œåº”è¯¥å¾—1åˆ†ã€‚
    // æ‰€ä»¥ï¼š
    // æ­£å‘é¢˜ï¼ˆç²¾åŠ›å……æ²›ï¼‰ï¼šLeft(1) -> Score 5. Formula: 6 - Val.
    // è´Ÿå‘é¢˜ï¼ˆå®¹æ˜“ç–²ä¹ï¼‰ï¼šLeft(1) -> Score 1. Formula: Val.
    { id: 60, text: "æ‚¨ç²¾åŠ›å……æ²›å—ï¼Ÿ", type: 'I', isPositivePingHe: true }, 
    { id: 61, text: "æ‚¨å®¹æ˜“ç–²ä¹å—ï¼Ÿ*", type: 'I', isNegativePingHe: true },
    { id: 62, text: "æ‚¨è¯´è¯å£°éŸ³ä½å¼±æ— åŠ›å—ï¼Ÿ*", type: 'I', isNegativePingHe: true },
    { id: 63, text: "æ‚¨æ„Ÿåˆ°é—·é—·ä¸ä¹ã€æƒ…ç»ªä½æ²‰å—ï¼Ÿ*", type: 'I', isNegativePingHe: true },
    { id: 64, text: "æ‚¨æ¯”ä¸€èˆ¬äººä¸äº†å¯’å†·å—ï¼Ÿ*", type: 'I', isNegativePingHe: true },
    { id: 65, text: "æ‚¨èƒ½é€‚åº”å¤–ç•Œè‡ªç„¶å’Œç¤¾ä¼šç¯å¢ƒçš„å˜åŒ–å—ï¼Ÿ", type: 'I', isPositivePingHe: true }
];

/**
 * ------------------------------------------------------------------
 * Logic & State
 * ------------------------------------------------------------------
 */
const state = {
    gender: 'undisclosed',
    answers: {}, // map qId -> value (1..5)
    page: 0,
    perPage: 8,
    filteredQ: [],
    history: [] // To modify answers if needed
};

// Initialization
function setGender(g, el) {
    state.gender = g;
    document.querySelectorAll('.gender-option').forEach(d => d.classList.remove('selected'));
    el.classList.add('selected');
}

function startQuiz() {
    // 1. Filter Questions
    state.filteredQ = QUESTIONS.filter(q => {
        if (!q.gender) return true;
        if (state.gender === 'undisclosed') return false; // Skip gender specific if undisclosed
        return q.gender === state.gender;
    });

    // 2. Initialize Answers (0 = unanswered)
    // If restarting, check if we have data to keep? No, startQuiz implies fresh start usually.
    // But if "Reviewing", we don't call startQuiz.
    if (Object.keys(state.answers).length === 0) {
        state.filteredQ.forEach(q => state.answers[q.id] = 0);
    }

    state.page = 0;
    switchView('view-quiz');
    renderPage();
}

function renderPage() {
    const start = state.page * state.perPage;
    const end = start + state.perPage;
    const currentQ = state.filteredQ.slice(start, end);
    const totalPages = Math.ceil(state.filteredQ.length / state.perPage);

    // Update Progress
    const progText = document.getElementById('progress-text');
    const progFill = document.getElementById('progress-fill');
    progText.textContent = `${state.page + 1}/${totalPages}`;
    progFill.style.width = `${((state.page + 1) / totalPages) * 100}%`;

    // Render Cards
    const container = document.getElementById('question-list');
    container.innerHTML = '';
    
    currentQ.forEach((q, idx) => {
        const val = state.answers[q.id];
        const globalIdx = start + idx + 1;
        
        const el = document.createElement('div');
        el.className = 'card question-card';
        if (val > 0) el.classList.add('active-card');
        el.id = `q-card-${q.id}`;
        
        el.innerHTML = `
            <div class="q-number">Question ${globalIdx}</div>
            <div class="q-text">${q.text}</div>
            
            <div class="slider-wrapper" id="slider-wrapper-${q.id}">
                <div class="slider-labels-top">
                    <span>æ€»æ˜¯/éå¸¸ (Always)</span>
                    <span>æ²¡æœ‰/æ ¹æœ¬ä¸ (Never)</span>
                </div>
                
                <!-- Custom Slider DOM -->
                <div class="slider-track-bg" onclick="handleSliderClick(event, ${q.id})">
                    <div class="slider-ticks">
                        <div class="tick" style="left:0%"></div>
                        <div class="tick" style="left:25%"></div>
                        <div class="tick" style="left:50%"></div>
                        <div class="tick" style="left:75%"></div>
                        <div class="tick" style="left:100%"></div>
                    </div>
                    <div class="slider-thumb ${val > 0 ? '' : 'hidden'}" id="thumb-${q.id}"
                         onmousedown="startDrag(event, ${q.id})"
                         ontouchstart="startDrag(event, ${q.id})"
                    ></div>
                </div>

                <div class="current-val-display ${val > 0 ? 'show' : ''}" id="val-disp-${q.id}">
                    ${getLabel(val)}
                </div>
            </div>
        `;
        container.appendChild(el);
        
        // Position thumb if value exists
        if (val > 0) {
            setTimeout(() => moveThumbVisual(q.id, val), 0);
        }
    });

    // Buttons
    const prevBtn = document.getElementById('btn-prev');
    const nextBtn = document.getElementById('btn-next');
    
    prevBtn.style.visibility = state.page === 0 ? 'hidden' : 'visible';
    
    if (state.page === totalPages - 1) {
        nextBtn.textContent = 'æäº¤æµ‹è¯• (Submit)';
        nextBtn.onclick = submitQuiz;
        nextBtn.style.backgroundColor = 'var(--primary-dark)';
    } else {
        nextBtn.textContent = 'ä¸‹ä¸€é¡µ (Next)';
        nextBtn.onclick = () => navPage(1);
        nextBtn.style.backgroundColor = 'var(--primary)';
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* --- Advanced Slider Logic --- */

function getLabel(val) {
    const map = {
        1: "æ€»æ˜¯ (Always) ğŸ”¥",
        2: "ç»å¸¸ (Often) ğŸ˜£",
        3: "æœ‰æ—¶ (Sometimes) ğŸ˜",
        4: "å¾ˆå°‘ (Rarely) ğŸ™‚",
        5: "æ²¡æœ‰ (Never) ğŸ§Š"
    };
    return map[val] || "";
}

function handleSliderClick(e, qId) {
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const width = rect.width;
    let pct = x / width;
    if(pct < 0) pct = 0; if(pct > 1) pct = 1;
    
    // Convert to 1..5
    // 0% = 1, 100% = 5
    // Steps: 0, 0.25, 0.5, 0.75, 1.0
    const rawStep = Math.round(pct * 4); // 0..4
    const val = rawStep + 1; // 1..5
    
    setAnswer(qId, val);
}

function setAnswer(qId, val) {
    state.answers[qId] = val;
    
    // UI Updates
    moveThumbVisual(qId, val);
    
    // Show Text
    const disp = document.getElementById(`val-disp-${qId}`);
    if (disp) {
        disp.textContent = getLabel(val);
        disp.classList.add('show');
    }
    
    // Card Style
    const card = document.getElementById(`q-card-${qId}`);
    if (card) {
        card.classList.add('active-card');
        card.classList.remove('error');
    }
}

function moveThumbVisual(qId, val) {
    const thumb = document.getElementById(`thumb-${qId}`);
    if (!thumb) return;
    
    thumb.classList.remove('hidden');
    // val 1..5 => 0%..100%
    const pct = (val - 1) * 25;
    thumb.style.left = `${pct}%`;
}

// Drag Logic
let draggingId = null;
function startDrag(e, qId) {
    draggingId = qId;
    const thumb = document.getElementById(`thumb-${qId}`);
    thumb.classList.add('dragging');
    thumb.classList.add('active');
    
    // Add global listeners
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchmove', onDrag, {passive: false});
    document.addEventListener('touchend', endDrag);
}

function onDrag(e) {
    if (!draggingId) return;
    e.preventDefault(); // prevent scroll on touch
    
    const wrapper = document.getElementById(`slider-wrapper-${draggingId}`);
    const track = wrapper.querySelector('.slider-track-bg');
    const rect = track.getBoundingClientRect();
    
    const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    let x = clientX - rect.left;
    let width = rect.width;
    
    let pct = x / width;
    if (pct < 0) pct = 0;
    if (pct > 1) pct = 1;
    
    // Move thumb visually immediately for smooth feel
    const thumb = document.getElementById(`thumb-${draggingId}`);
    thumb.style.left = `${pct * 100}%`;
    
    // Don't set answer yet, just visual
}

function endDrag(e) {
    if (!draggingId) return;
    
    const wrapper = document.getElementById(`slider-wrapper-${draggingId}`);
    const track = wrapper.querySelector('.slider-track-bg');
    const rect = track.getBoundingClientRect();
    const thumb = document.getElementById(`thumb-${draggingId}`);
    
    // Determine closest snap
    const currentLeftPct = parseFloat(thumb.style.left); // 0..100
    const rawStep = Math.round(currentLeftPct / 25);
    const val = rawStep + 1;
    
    setAnswer(draggingId, val); // This snaps it to grid
    
    thumb.classList.remove('dragging');
    thumb.classList.remove('active');
    draggingId = null;
    
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', endDrag);
    document.removeEventListener('touchmove', onDrag);
    document.removeEventListener('touchend', endDrag);
}


/* --- Navigation & Submission --- */

function navPage(dir) {
    state.page += dir;
    renderPage();
}

function submitQuiz() {
    // Check missing
    const missing = state.filteredQ.filter(q => state.answers[q.id] === 0);
    if (missing.length > 0) {
        showAlert(`è¿˜æœ‰ ${missing.length} é“é¢˜ç›®æœªå®Œæˆï¼Œè¯·æ£€æŸ¥ã€‚`);
        // Jump to page
        const firstIdx = state.filteredQ.indexOf(missing[0]);
        const targetPage = Math.floor(firstIdx / state.perPage);
        state.page = targetPage;
        renderPage();
        setTimeout(() => {
            const card = document.getElementById(`q-card-${missing[0].id}`);
            if (card) {
                card.scrollIntoView({behavior:'smooth', block:'center'});
                card.classList.add('error');
            }
        }, 300);
        return;
    }
    
    calcResult();
}

function calcResult() {
    // Score Calculation
    // Formula: [(Raw - N) / (N*4)] * 100
    // Raw: sum of points.
    // Point Logic:
    // Most Qs: Left(1)=Always -> Score 5. Right(5)=Never -> Score 1. (Score = 6 - Val)
    // PingHe Positive: Left(1)=Always -> Score 5. (Score = 6 - Val)
    // PingHe Negative (*): Left(1)=Always -> Score 1. (Score = Val)
    
    const scores = {}; // Type -> 0..100
    
    Object.keys(TYPES).forEach(t => {
        const typeQs = state.filteredQ.filter(q => q.type === t);
        if (typeQs.length === 0) { scores[t] = 0; return; }
        
        let rawSum = 0;
        typeQs.forEach(q => {
            const val = state.answers[q.id];
            let point = 0;
            
            if (t === 'I') {
                if (q.isNegativePingHe) point = val; // 1->1
                else point = 6 - val; // 1->5
            } else {
                point = 6 - val; // Pathological types: Always(1) is bad(5 pts)
            }
            rawSum += point;
        });
        
        const n = typeQs.length;
        const finalS = ((rawSum - n) / (n * 4)) * 100;
        scores[t] = parseFloat(finalS.toFixed(1));
    });

    // Determination Logic
    // 1. Pathological Types (A-H) >= 40?
    // 2. PingHe (I) >= 60 and others < 30(40)?
    
    const pathTypes = ['A','B','C','D','E','F','G','H'];
    const pathScores = pathTypes.map(id => ({ id, score: scores[id], name: TYPES[id].name }));
    
    // Sort pathological by score descending
    pathScores.sort((a,b) => b.score - a.score);
    
    const maxPathScore = pathScores[0].score;
    const pingHeScore = scores['I'];
    
    let mainResult = "";
    let subDesc = "";
    let tags = [];

    // Core Logic
    if (pingHeScore >= 60 && maxPathScore < 40) {
        // PingHe is dominant
        mainResult = "å¹³å’Œè´¨";
        subDesc = `æ­å–œæ‚¨ï¼æ‚¨çš„ä½“è´¨é˜´é˜³å¹³è¡¡ï¼Œè„è…‘åè°ƒã€‚`;
        tags.push(`å¥åº·æŒ‡æ•° ${pingHeScore}`);
        if (maxPathScore >= 30) {
            pathScores.filter(x => x.score >= 30).forEach(x => tags.push(`å€¾å‘${x.name}`));
        }
    } else {
        // Pathological
        if (maxPathScore >= 40) {
            // Pick the HIGHEST score as Main
            const mainTypeObj = pathScores[0];
            mainResult = mainTypeObj.name;
            subDesc = `æ‚¨çš„ä½“è´¨ä¸»è¦è¡¨ç°ä¸º${mainTypeObj.name}ç‰¹å¾ã€‚`;
            
            // Check for others >= 40 (Concurrent)
            const concurrent = pathScores.filter(x => x.score >= 40 && x.id !== mainTypeObj.id);
            if (concurrent.length > 0) {
                subDesc += ` åŒæ—¶å…¼æœ‰ ${concurrent.map(x=>x.name).join('ã€')}ã€‚`;
                concurrent.forEach(x => tags.push(`å…¼æœ‰${x.name}`));
            }
            
            // Tendencies
            const tendency = pathScores.filter(x => x.score >= 30 && x.score < 40);
            tendency.forEach(x => tags.push(`å€¾å‘${x.name}`));
        } else {
            // No type >= 40, but PingHe also < 60?
            // "Undefined" or "Sub-health"
            mainResult = "äºšå¥åº· (åé¢‡å€¾å‘)";
            subDesc = "æ‚¨çš„å„é¡¹ä½“è´¨å¾—åˆ†å‡æœªè¾¾åˆ°æ˜æ˜¾é˜ˆå€¼ï¼Œä½†å¹³å’Œè´¨å¾—åˆ†ä¹Ÿè¾ƒä½ï¼Œå¤„äºè°ƒèŠ‚æœŸã€‚";
            pathScores.filter(x => x.score >= 30).forEach(x => tags.push(`å€¾å‘${x.name}`));
        }
    }

    renderResultView(mainResult, subDesc, tags, pathScores, scores);
}

function renderResultView(main, sub, tags, sortedPath, allScores) {
    document.getElementById('res-main-title').textContent = main;
    document.getElementById('res-sub-desc').textContent = sub;
    
    const tagContainer = document.getElementById('res-tags');
    tagContainer.innerHTML = tags.map(t => `<span style="background:rgba(188,143,88,0.1); color:var(--primary-dark); padding:4px 10px; border-radius:8px; font-size:12px;">${t}</span>`).join('');
    
    // Chart
    const chart = document.getElementById('chart-container');
    chart.innerHTML = '';
    
    // Add PingHe first
    const chartData = [...sortedPath];
    chartData.unshift({ id: 'I', name: 'å¹³å’Œè´¨', score: allScores['I'] }); // Put PingHe at top
    
    chartData.forEach(item => {
        let fillClass = '';
        if (item.id === 'I') {
            fillClass = item.score >= 60 ? 'health' : 'mid';
        } else {
            if (item.score >= 40) fillClass = 'high';
            else if (item.score >= 30) fillClass = 'mid';
            else fillClass = '';
        }
        
        const row = document.createElement('div');
        row.className = 'bar-row';
        row.innerHTML = `
            <div class="bar-label">${TYPES[item.id].emoji} ${item.name}</div>
            <div class="bar-track">
                <div class="bar-fill ${fillClass}" style="width:0%" data-w="${item.score}%"></div>
            </div>
            <div class="bar-val">${item.score}</div>
        `;
        chart.appendChild(row);
    });
    
    // Trigger animation
    setTimeout(() => {
        document.querySelectorAll('.bar-fill').forEach(b => b.style.width = b.getAttribute('data-w'));
    }, 100);

    // Advice
    const adviceDiv = document.getElementById('advice-list');
    let adviceHTML = '';
    
    // Get top 2 unbalanced
    const problems = sortedPath.filter(x => x.score >= 30).slice(0, 3);
    
    if (problems.length === 0) {
        adviceHTML = `<div class="advice-item">
            <div class="advice-title">ğŸƒ ä¿æŒç§˜ç±</div>
            <div style="font-size:14px; color:#666;">æ‚¨çš„çŠ¶æ€éå¸¸å¥½ï¼å»ºè®®ç»§ç»­ä¿æŒè§„å¾‹ä½œæ¯ï¼Œé¥®é£Ÿå¤šæ ·åŒ–ï¼Œé¡ºåº”å››å­£å˜åŒ–ã€‚</div>
        </div>`;
    } else {
        problems.forEach(p => {
            const info = TYPES[p.id];
            adviceHTML += `<div class="advice-item">
                <div class="advice-title">${info.emoji} é’ˆå¯¹${info.name} (${p.score}åˆ†)</div>
                <div style="font-size:14px; color:#666;">${info.desc} å»ºè®®å’¨è¯¢ä¸“ä¸šä¸­åŒ»å¸ˆè¿›è¡Œè°ƒç†ï¼Œæ—¥å¸¸æ³¨æ„é¥®é£Ÿç¦å¿Œã€‚</div>
            </div>`;
        });
    }
    adviceDiv.innerHTML = adviceHTML;

    switchView('view-result');
}

function reviewAnswers() {
    // Go back to quiz view, do not reset data
    switchView('view-quiz');
    // Maybe go to first page
    state.page = 0;
    renderPage();
}

function resetApp() {
    state.answers = {};
    switchView('view-landing');
}

function confirmExit() {
    if(confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
        resetApp();
    }
}

/* --- Utilities --- */
function switchView(id) {
    ['view-landing', 'view-quiz', 'view-result'].forEach(v => document.getElementById(v).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
}

function showInfoModal() { document.getElementById('modal-info').classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function showAlert(msg) {
    document.getElementById('alert-msg').textContent = msg;
    document.getElementById('modal-alert').classList.add('active');
}

</script>
</body>
</html>